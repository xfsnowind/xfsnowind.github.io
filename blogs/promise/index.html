<!doctype html><html lang=en data-figures class=page><head><title>Promise implementation | xfsnowind</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv=x-ua-compatible content="IE=edge"><script async src="https://www.googletagmanager.com/gtag/js?id=XXXXXXXXXX"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","XXXXXXXXXX")</script><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta name=description content="Promise is a general concept to handle the asynchronize development in javascript. It's not hard to use, but when it comes with some other concepts, like ‚Ä¶"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@xfsnowind"><meta name=twitter:title content="Promise implementation"><meta name=twitter:image content="https://xfsnowind.github.io/images/thumbnail.png"><meta property="og:url" content="https://xfsnowind.github.io/blogs/promise/"><meta property="og:title" content="Promise implementation"><meta property="og:description" content="Promise is a general concept to handle the asynchronize development in javascript. It's not hard to use, but when it comes with some other concepts, like ‚Ä¶"><meta property="og:image" content="https://xfsnowind.github.io/images/thumbnail.png"><link rel=apple-touch-icon sizes=180x180 href=https://xfsnowind.github.io/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://xfsnowind.github.io/icons/favicon-32x32.png><link rel=manifest href=https://xfsnowind.github.io/icons/site.webmanifest><link rel=canonical href=https://xfsnowind.github.io/blogs/promise/><link rel=preload href=https://xfsnowind.github.io/css/styles.c6e01901466e73804d4990c0c395801e4e907de2458147dac9d39bdfa7f257fc8302c2c38ed756568a9317f1b95c450431e8101ac8f1caae397f7b5d74264e16.css integrity="sha512-xuAZAUZuc4BNSZDAw5WAHk6QfeJFgUfaydOb36fyV/yDAsLDjtdWVoqTF/G5XEUEMegQGsjxyq45f3tddCZOFg==" as=style crossorigin=anonymous><link rel=preload href=https://xfsnowind.github.io/en/js/bundle.abda53b0d8eb8de877a2fbec2599375291f77ae51211052d48f67bac51bab59515a0317b52db7e934e984e7f67086227055e81e818724a66f0ef38d841085056.js as=script integrity="sha512-q9pTsNjrjeh3ovvsJZk3UpH3euUSEQUtSPZ7rFG6tZUVoDF7Utt+k06YTn9nCGInBV6B6BhySmbw7zjYQQhQVg==" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://xfsnowind.github.io/css/styles.c6e01901466e73804d4990c0c395801e4e907de2458147dac9d39bdfa7f257fc8302c2c38ed756568a9317f1b95c450431e8101ac8f1caae397f7b5d74264e16.css integrity="sha512-xuAZAUZuc4BNSZDAw5WAHk6QfeJFgUfaydOb36fyV/yDAsLDjtdWVoqTF/G5XEUEMegQGsjxyq45f3tddCZOFg==" crossorigin=anonymous></head><body data-code=50 data-lines=true id=documentTop data-lang=en><header class=nav_header><nav class=nav><a href=https://xfsnowind.github.io class="nav_brand nav_item" title=xfsnowind><img src=https://xfsnowind.github.io/icons/logo.png class=logo alt=xfsnowind><div class=nav_close><div><svg class="icon"><title>open-menu</title><use xlink:href="#open-menu"/></svg><svg class="icon"><title>closeme</title><use xlink:href="#closeme"/></svg></div></div></a><div class='nav_body nav_body_left'><div class=nav_parent><a href=https://xfsnowind.github.io class=nav_item title=Home>Home</a></div><div class=nav_parent><a href=https://xfsnowind.github.io/blogs class=nav_item title=Blog>Blog</a></div><div class=nav_parent><a href=https://xfsnowind.github.io/about class=nav_item title=About>About</a></div><div class=nav_parent><a href=# class=nav_item>üåê</a><div class=nav_sub><span class=nav_child></span>
<a href=https://xfsnowind.github.io/ class="nav_child nav_item">English</a>
<a href=https://xfsnowind.github.io/zh-cn/ class="nav_child nav_item">ÁÆÄ‰Ωì‰∏≠Êñá</a></div></div><div class=follow><a href=https://github.com/xfsnowind><svg class="icon"><title>github</title><use xlink:href="#github"/></svg></a><a href=https://twitter.com/xfsnowind><svg class="icon"><title>twitter</title><use xlink:href="#twitter"/></svg></a><a href=https://www.linkedin.com/in/feng-xue-60175a37/><svg class="icon"><title>linkedin</title><use xlink:href="#linkedin"/></svg></a><a href=https://xfsnowind.github.io/index.xml><svg class="icon"><title>rss</title><use xlink:href="#rss"/></svg></a><div class=color_mode><input type=checkbox class=color_choice id=mode></div></div></div></nav></header><main><div class="grid-inverse wrap content"><article class=post_content><h1 class=post_title>Promise implementation</h1><div class=post_meta><span><svg class="icon"><title>calendar</title><use xlink:href="#calendar"/></svg></span><span class=post_date>Aug 6, 2022</span>
<span class=post_time>¬∑ 17 min read</span><span>&nbsp;¬∑ <a href=https://xfsnowind.github.io/tags/javascript/ title=Javascript class="post_tag button button_translucent">Javascript
</a><a href=https://xfsnowind.github.io/tags/promise/ title=Promise class="post_tag button button_translucent">Promise</a></span>
<span class=page_only>&nbsp;¬∑<div class=post_share>Share on:
<a href="https://twitter.com/intent/tweet?text=Promise%20implementation&url=https%3a%2f%2fxfsnowind.github.io%2fblogs%2fpromise%2f&tw_p=tweetbutton" class=twitter title="Share on Twitter" target=_blank rel=nofollow><svg class="icon"><title>twitter</title><use xlink:href="#twitter"/></svg></a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fxfsnowind.github.io%2fblogs%2fpromise%2f&t=Promise%20implementation" class=facebook title="Share on Facebook" target=_blank rel=nofollow><svg class="icon"><title>facebook</title><use xlink:href="#facebook"/></svg></a><a href=#linkedinshare id=linkedinshare class=linkedin title="Share on LinkedIn" rel=nofollow><svg class="icon"><title>linkedin</title><use xlink:href="#linkedin"/></svg></a><a href=https://xfsnowind.github.io/blogs/promise/ title="Copy Link" class="link link_yank"><svg class="icon"><title>copy</title><use xlink:href="#copy"/></svg></a></div></span></div><div class=post_body><p>Promise is a general concept to handle the asynchronize development in javascript. It's not hard to use, but when it comes with some other concepts, like react's hook, its internal chain etc. It always takes me some time to think through it. Especially when check the code of some open-source libraries, find the way they use Promise is quite fancy and also hard to understand, which reminders me that I am still stay on the level of using, far away from deep understanding.</p><p>Inspired by <a href=https://developpaper.com/source-code-implementation-of-promise-perfect-in-accordance-with-promise-a-specification/>this blog</a>, I think it's a good idea to write promise by myself. It's not only because it's not that hard and complex, it can also help me in the future work when I meet it again. Thesedays, function programing is quite popular in js development, but object-orient coding is still used in lots of scenarioes. So I would like to try to implement it with both function and class, even though javascript's prototype is almost equal to class concept, which was introduced in ES2015. It can also train these basic skills again. I would deploy them in my github and write blogs to record it.</p><p>Thanks to <a href=https://promisesaplus.com/>promise/A+</a>, we get the requirement analysis, clear logic and <a href=https://github.com/promises-aplus/promises-tests>library</a> to test the solution.</p><h2 id=steps>Steps</h2><p>According to the Promise/A+'s requirements, I think it would be four steps:</p><ol><li>Basic <code>then</code> function -- 1.1, 1.2</li><li>Fulfill <code>Promise</code> and <code>then</code> parameters -- from 2.1 to 2.2.5</li><li>Return a <code>Promise</code> in <code>then</code> -- 2.2.6, 2.2.7</li><li><code>resolve</code> function -- 2.3</li></ol><h2 id=basic-thenable>Basic <code>thenable</code></h2><p>According to the Terminology, the first two are <code>promise</code> and <code>thenable</code>. The former should take a function (an <code>executor</code>) as parameter which would take two functions (<code>resolve</code> and <code>reject</code>) as parameters as well. Check <a href=https://en.wikipedia.org/wiki/Higher-order_function>Higher-order functions</a>. These <code>resolve</code> and <code>reject</code> would be used in the <code>executor</code> and defined in the <code>then</code>'s parameters. Let's simply implement this <code>thenable</code> first.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>executor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=kd>let</span> <span class=nx>self</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=nx>self</span><span class=p>.</span><span class=nx>executor</span> <span class=o>=</span> <span class=nx>executor</span><span class=p>;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=nb>Promise</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>then</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>onFulfilled</span><span class=p>,</span> <span class=nx>onRejected</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>  <span class=kd>let</span> <span class=nx>self</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=ln>8</span><span class=cl>  <span class=nx>self</span><span class=p>.</span><span class=nx>executor</span><span class=p>(</span><span class=nx>onFulfilled</span><span class=p>,</span> <span class=nx>onRejected</span><span class=p>);</span>
</span></span><span class=line><span class=ln>9</span><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>As we see, we just delay the execution of <code>executor</code> from <code>Promise</code> to <code>then</code> and the fulfill and reject functions are used in <code>executor</code> while defined or passed in <code>then</code>.</p><p>We can use below code to test it. <strong><em>NB</em></strong>: do not use arrow function in definition, because arrow function does not own <code>this</code>. If we use <code>this</code> inside of it, it would refer to the outer function. Check <a href=https://javascript.info/object-methods#arrow-functions-have-no-this>here</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln>1</span><span class=cl><span class=kr>const</span> <span class=nx>a</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>resolve</span><span class=p>(</span><span class=s2>&#34;result&#34;</span><span class=p>),</span> <span class=mi>100</span><span class=p>));</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=nx>a</span><span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Data&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=c1>// console.log -&gt; Data: result
</span></span></span></code></pre></div><p>But obviously here, we only have one <code>executor</code> and the parameters are not validated. Besides <code>executor</code> runs in the <code>then</code>, not in the <code>Promise</code>. Currently, the code is simple, but it would cause problems. We will mention this below, let's go further.</p><h2 id=fulfill-promise-and-then-parameters>Fulfill <code>Promise</code> and <code>then</code> parameters</h2><h3 id=validate-then-parameters>Validate <code>then</code> parameters</h3><blockquote><p>2.2.1 Both onFulfilled and onRejected are optional arguments:<br>¬†¬†¬†2.2.1.1 If onFulfilled is not a function, it must be ignored.<br>¬†¬†¬†2.2.1.2 If onRejected is not a function, it must be ignored.</p></blockquote><p><code>onFulfilled</code> and <code>onRejected</code> should be validated:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln>1</span><span class=cl><span class=kd>let</span> <span class=nx>fulfillFunc</span> <span class=o>=</span> <span class=nx>isFunction</span><span class=p>(</span><span class=nx>onFulfilled</span><span class=p>)</span> <span class=o>?</span> <span class=nx>onFulfilled</span> <span class=o>:</span> <span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=kd>let</span> <span class=nx>rejectFunc</span> <span class=o>=</span> <span class=nx>isFunction</span><span class=p>(</span><span class=nx>onRejected</span><span class=p>)</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=o>?</span> <span class=nx>onRejected</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>  <span class=o>:</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>      <span class=k>throw</span> <span class=nx>e</span><span class=p>;</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>    <span class=p>};</span>
</span></span></code></pre></div><h3 id=update-state>Update state</h3><p>After validating the parameters, we can implement the point <code>2.2.2</code> and <code>2.2.3</code>. Translate here:</p><blockquote><p>If onFulfilled/onRejected is a function,<br>¬†¬†¬†it must be called after promise is fulfilled/rejected, with promise's value/reason as its first argument;<br>¬†¬†¬†it must not be called before promise is fulfilled/rejected;<br>¬†¬†¬†it must not be called more than once;</p></blockquote><p>So we need to set the state and pass the value or reason to related functions. To do this, I wrap the validated functions and update internal states inside of them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// 2.2.2.1 onFulfilled must be called after promise is fulfilled, with promise‚Äôs value as its first argument.
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>===</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=c1>// 2.2.2.2 it must not be called before promise is fulfilled.
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1></span>    <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>=</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>FULFILLED</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=nx>self</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=nx>fulfillFunc</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=c1>// 2.2.3.1 onRejected must be called after promise is rejected, with promise‚Äôs reason as its first argument.
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>===</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=c1>// 2.2.3.2 it must not be called before promise is rejected.
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=c1></span>    <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>=</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>REJECTED</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=nx>self</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>err</span><span class=p>;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=nx>rejectFunc</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=asynchronized-execution>Asynchronized execution</h3><p>According to the first point <code>2.2.4</code> refering NOTE <code>3.1</code>, we should execute the fulfill and reject functions asynchronously, which is the main reason for people using it. In javascript, we can utilize <code>setTimeout</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln>1</span><span class=cl><span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>fulfillFunc</span><span class=p>(</span><span class=nx>value</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span></code></pre></div><h2 id=return-promise-in-then>Return <code>Promise</code> in <code>then</code></h2><p>Before we continue implementing the rest requirement, we need to reorganize the codes first. We need to move the <code>executor</code> from <code>then</code> to the constructor of <code>Promise</code>.</p><p>Why? One main reason is we will execute the <code>executor</code> multiple times if it's in <code>then</code>, since one promise can have multiple <code>then</code>s. This is definitely unacceptable because we only need to execute <code>executor</code> once.</p><p>So til now, the <code>Promise</code> function looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>executor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=kd>let</span> <span class=nx>self</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=c1>// set the state as pending, 2.1.1
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1></span>  <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>=</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=c1>// 2.2.2.1 onFulfilled must be called after promise is fulfilled, with promise‚Äôs value as its first argument.
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1></span>  <span class=kd>function</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>===</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>      <span class=c1>// 2.2.2.2 it must not be called before promise is fulfilled.
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=c1></span>      <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>=</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>FULFILLED</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>      <span class=nx>self</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>      <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>resolveFunc</span><span class=p>(</span><span class=nx>value</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>
</span></span><span class=line><span class=ln>17</span><span class=cl>  <span class=c1>// 2.2.3.1 onRejected must be called after promise is rejected, with promise‚Äôs reason as its first argument.
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1></span>  <span class=kd>function</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>===</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>      <span class=c1>// 2.2.3.2 it must not be called before promise is rejected.
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=c1></span>      <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>=</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>REJECTED</span><span class=p>;</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>      <span class=nx>self</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>err</span><span class=p>;</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>      <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>rejectFunc</span><span class=p>(</span><span class=nx>err</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>
</span></span><span class=line><span class=ln>27</span><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>    <span class=c1>// executor is function whose parameters is resolve and reject functions,
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=c1></span>    <span class=c1>// which would be called inside of executor.
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>executor</span><span class=p>))</span> <span class=nx>executor</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>);</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>    <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>34</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And you may notice we use the function <code>resolveFunc</code> and <code>rejectFunc</code>, but we haven't define them. They would work together with the requirement of multiple calling of <code>then</code>.</p><h3 id=call-then-mutiple-times-226>Call <code>then</code> mutiple times 2.2.6</h3><blockquote><p>2.2.6 <code>then</code> may be called multiple times on the same promise.</p></blockquote><p>So all the respective <em>fulfill/reject</em> functions should be called in the order of original calls. Obviously, we can apply a queue here. Create a callback queue, add <code>then</code>'s <code>onFulfilled</code> and <code>onRejected</code> parameters to it and handle it when fulfilled/rejected. And this is how we handle the above <code>resolveFunc</code> and <code>rejectFunc</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=c1>// 2.2.6.1
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=c1></span>  <span class=nx>setTimeout</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>self</span><span class=p>.</span><span class=nx>callback</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(({</span> <span class=nx>resolveFunc</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=nx>resolveFunc</span><span class=p>(</span><span class=nx>value</span><span class=p>)),</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=mi>0</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=kd>function</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>  <span class=c1>// 2.2.6.2
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>  <span class=nx>setTimeout</span><span class=p>(</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>self</span><span class=p>.</span><span class=nx>callback</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(({</span> <span class=nx>rejectFunc</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=nx>rejectFunc</span><span class=p>(</span><span class=nx>err</span><span class=p>)),</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=mi>0</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>When <code>Promise</code> is fulfilled/rejected, we would execute all the related functions in the queue. And obviously, we have to push the callback functions to the queue in <code>then</code> when the state is still pending.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=nb>Promise</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>then</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>onFulfilled</span><span class=p>,</span> <span class=nx>onRejected</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=kd>let</span> <span class=nx>self</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=c1>// 2.2.1 Both onFulfilled and onRejected are optional arguments, if any is not function, must ignore it
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>fulfillFunc</span> <span class=o>=</span> <span class=nx>isFunction</span><span class=p>(</span><span class=nx>onFulfilled</span><span class=p>)</span> <span class=o>?</span> <span class=nx>onFulfilled</span> <span class=o>:</span> <span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=kd>let</span> <span class=nx>rejectFunc</span> <span class=o>=</span> <span class=nx>isFunction</span><span class=p>(</span><span class=nx>onRejected</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=o>?</span> <span class=nx>onRejected</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=o>:</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>        <span class=k>throw</span> <span class=nx>e</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>state</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=c1>// if the state is fulfilled or rejected, just execute the related function and pass the result to the resolvePromise
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=c1></span>    <span class=k>case</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>FULFILLED</span><span class=o>:</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=k>case</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>REJECTED</span><span class=o>:</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>      <span class=k>return</span> <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>        <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>          <span class=kd>let</span> <span class=nx>func</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>FULFILLED</span> <span class=o>?</span> <span class=nx>fulfillFunc</span> <span class=o>:</span> <span class=nx>rejectFunc</span><span class=p>;</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>          <span class=nx>func</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>          <span class=nx>rejectFunc</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>      <span class=p>},</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=k>case</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=o>:</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>      <span class=c1>// if it&#39;s still pending, push the resolve/reject to callback queue. All the callback functions would be executed once state are changed
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=nx>self</span><span class=p>.</span><span class=nx>callback</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>        <span class=nx>resolveFunc</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>          <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>            <span class=nx>fulfillFunc</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>          <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>            <span class=nx>rejectFunc</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>        <span class=nx>rejectFunc</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>          <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>            <span class=nx>rejectFunc</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>          <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>            <span class=nx>rejectFunc</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=ln>42</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>43</span><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h3 id=return-promise-227>Return <code>Promise</code> 2.2.7</h3><p>Here comes the difficult part, <code>then</code> should return a <code>Promise</code> which would support the chaining feature.</p><blockquote><p>then must return a promise [3.3].<br>¬†¬†¬†<code>promise2 = promise1.then(onFulfilled, onRejected);</code></p></blockquote><p>After reading other implementations, here comes a question. Would this <code>promise2</code> have its own <code>executor</code>? Yes or no would have different implementations.</p><p>Let's first implement the simple one - <strong>Yes</strong>. It would have its own <code>resolve/reject</code> functions in <code>executor</code>. I would implement the optimized one -- <strong>No</strong>, with an empty promise, in another blog.</p><p>Another thing we need to think of is what if the value returned by <code>promise2</code> is a promise. This is what the <code>2.3 Promise Resolution Procedure</code> would do. Let's preserve this to later chapter and assume the value returned by <code>promise2</code> is <strong><em>NOT</em></strong> another promise
Then the logic of this <code>promise2</code>'s <code>executor</code> should be:</p><ol><li>If the state is fulfilled, the value returned by the <code>onFulfilled</code> function should be passed to <code>resolve2</code> function in <code>promise2</code>'s executor</li><li>If the state is rejected, the value returned by the <code>onRejected</code> function should be passed to <code>reject2</code> function in <code>promise2</code>'s executor</li><li>If the state is still pending, pass the <code>resolveFunc</code> and <code>rejectFunc</code> which would call <code>resolve2</code> and <code>reject2</code>, to callback queue</li><li>Any exception throwed by <code>onFulfilled</code> or <code>onRejected</code> should be handled by <code>reject2</code></li></ol><p>And we can extract the process of handling <code>self.value</code> as a function to reuse code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nx>handleResult</span><span class=p>(</span><span class=nx>resolve2</span><span class=p>,</span> <span class=nx>reject2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>      <span class=c1>// 2.2.7.1, 2.2.7.2
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1></span>      <span class=kd>let</span> <span class=nx>func</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>FULFILLED</span> <span class=o>?</span> <span class=nx>fulfillFunc</span> <span class=o>:</span> <span class=nx>rejectFunc</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>      <span class=kd>let</span> <span class=nx>func2</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>FULFILLED</span> <span class=o>?</span> <span class=nx>resolve2</span> <span class=o>:</span> <span class=nx>reject2</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>      <span class=nx>func2</span><span class=p>(</span><span class=nx>func</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>value</span><span class=p>));</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>      <span class=nx>reject2</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Til now, we have implement the features</p><ol><li>Return Promise in <code>then</code> to support chaining</li><li>Multiple <code>then</code> of one Promise</li></ol><p>The codes should be like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=kr>const</span> <span class=nx>STATE</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=nx>PENDING</span><span class=o>:</span> <span class=nx>Symbol</span><span class=p>.</span><span class=k>for</span><span class=p>(</span><span class=s2>&#34;pending&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=nx>FULFILLED</span><span class=o>:</span> <span class=nx>Symbol</span><span class=p>.</span><span class=k>for</span><span class=p>(</span><span class=s2>&#34;fulfilled&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=nx>REJECTED</span><span class=o>:</span> <span class=nx>Symbol</span><span class=p>.</span><span class=k>for</span><span class=p>(</span><span class=s2>&#34;rejected&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=kr>const</span> <span class=nx>isFunction</span> <span class=o>=</span> <span class=p>(</span><span class=nx>func</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>func</span> <span class=o>&amp;&amp;</span> <span class=k>typeof</span> <span class=nx>func</span> <span class=o>===</span> <span class=s2>&#34;function&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=kr>const</span> <span class=nx>isObject</span> <span class=o>=</span> <span class=p>(</span><span class=nx>arg</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>arg</span> <span class=o>&amp;&amp;</span> <span class=k>typeof</span> <span class=nx>arg</span> <span class=o>===</span> <span class=s2>&#34;object&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=kd>function</span> <span class=nb>Promise</span><span class=p>(</span><span class=nx>executor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=kd>let</span> <span class=nx>self</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=c1>// set the state as pending, 2.1.1
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=c1></span>  <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>=</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=p>;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl>  <span class=nx>self</span><span class=p>.</span><span class=nx>callback</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>
</span></span><span class=line><span class=ln>18</span><span class=cl>  <span class=c1>// 2.2.2.1 onFulfilled must be called after promise is fulfilled, with promise‚Äôs value as its first argument.
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=c1></span>  <span class=kd>function</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>===</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>      <span class=c1>// 2.2.2.2 it must not be called before promise is fulfilled.
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=c1></span>      <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>=</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>FULFILLED</span><span class=p>;</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>      <span class=nx>self</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>      <span class=c1>// 2.2.6.1
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=c1></span>      <span class=nx>setTimeout</span><span class=p>(</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>        <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>self</span><span class=p>.</span><span class=nx>callback</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(({</span> <span class=nx>resolveFunc</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=nx>resolveFunc</span><span class=p>(</span><span class=nx>value</span><span class=p>)),</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>        <span class=mi>0</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>
</span></span><span class=line><span class=ln>32</span><span class=cl>  <span class=c1>// 2.2.3.1 onRejected must be called after promise is rejected, with promise‚Äôs reason as its first argument.
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=c1></span>  <span class=kd>function</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>===</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>      <span class=c1>// 2.2.3.2 it must not be called before promise is rejected.
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=c1></span>      <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>=</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>REJECTED</span><span class=p>;</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>      <span class=nx>self</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>err</span><span class=p>;</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>      <span class=c1>// 2.2.6.2
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=c1></span>      <span class=nx>setTimeout</span><span class=p>(</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>        <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>self</span><span class=p>.</span><span class=nx>callback</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(({</span> <span class=nx>rejectFunc</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=nx>rejectFunc</span><span class=p>(</span><span class=nx>err</span><span class=p>)),</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>        <span class=mi>0</span>
</span></span><span class=line><span class=ln>42</span><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=ln>43</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>44</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>45</span><span class=cl>
</span></span><span class=line><span class=ln>46</span><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>47</span><span class=cl>    <span class=c1>// executor is function whose parameters is resolve and reject functions,
</span></span></span><span class=line><span class=ln>48</span><span class=cl><span class=c1></span>    <span class=c1>// which would be called inside of executor.
</span></span></span><span class=line><span class=ln>49</span><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>executor</span><span class=p>))</span> <span class=nx>executor</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>);</span>
</span></span><span class=line><span class=ln>50</span><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>51</span><span class=cl>    <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=ln>52</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>53</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>54</span><span class=cl>
</span></span><span class=line><span class=ln>55</span><span class=cl><span class=nb>Promise</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>then</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>onFulfilled</span><span class=p>,</span> <span class=nx>onRejected</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>56</span><span class=cl>  <span class=kd>let</span> <span class=nx>self</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=ln>57</span><span class=cl>
</span></span><span class=line><span class=ln>58</span><span class=cl>  <span class=c1>// 2.2.1 Both onFulfilled and onRejected are optional arguments, if any is not function, must ignore it
</span></span></span><span class=line><span class=ln>59</span><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>fulfillFunc</span> <span class=o>=</span> <span class=nx>isFunction</span><span class=p>(</span><span class=nx>onFulfilled</span><span class=p>)</span> <span class=o>?</span> <span class=nx>onFulfilled</span> <span class=o>:</span> <span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=ln>60</span><span class=cl>  <span class=kd>let</span> <span class=nx>rejectFunc</span> <span class=o>=</span> <span class=nx>isFunction</span><span class=p>(</span><span class=nx>onRejected</span><span class=p>)</span>
</span></span><span class=line><span class=ln>61</span><span class=cl>    <span class=o>?</span> <span class=nx>onRejected</span>
</span></span><span class=line><span class=ln>62</span><span class=cl>    <span class=o>:</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>63</span><span class=cl>        <span class=k>throw</span> <span class=nx>e</span><span class=p>;</span>
</span></span><span class=line><span class=ln>64</span><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=ln>65</span><span class=cl>
</span></span><span class=line><span class=ln>66</span><span class=cl>  <span class=kd>function</span> <span class=nx>handleResult</span><span class=p>(</span><span class=nx>resolve2</span><span class=p>,</span> <span class=nx>reject2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>67</span><span class=cl>    <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>68</span><span class=cl>      <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>69</span><span class=cl>        <span class=c1>// 2.2.7.1, 2.2.7.2
</span></span></span><span class=line><span class=ln>70</span><span class=cl><span class=c1></span>        <span class=kd>let</span> <span class=nx>func</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>FULFILLED</span> <span class=o>?</span> <span class=nx>fulfillFunc</span> <span class=o>:</span> <span class=nx>rejectFunc</span><span class=p>;</span>
</span></span><span class=line><span class=ln>71</span><span class=cl>        <span class=kd>let</span> <span class=nx>func2</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>FULFILLED</span> <span class=o>?</span> <span class=nx>resolve2</span> <span class=o>:</span> <span class=nx>reject2</span><span class=p>;</span>
</span></span><span class=line><span class=ln>72</span><span class=cl>        <span class=nx>func2</span><span class=p>(</span><span class=nx>func</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>value</span><span class=p>));</span>
</span></span><span class=line><span class=ln>73</span><span class=cl>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>74</span><span class=cl>        <span class=nx>reject2</span><span class=p>(</span><span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=ln>75</span><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=ln>76</span><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=ln>77</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>78</span><span class=cl>
</span></span><span class=line><span class=ln>79</span><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve2</span><span class=p>,</span> <span class=nx>reject2</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>80</span><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>state</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>81</span><span class=cl>      <span class=c1>// if the state is fulfilled or rejected, just execute the related function and pass the result to the resolvePromise
</span></span></span><span class=line><span class=ln>82</span><span class=cl><span class=c1></span>      <span class=k>case</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>FULFILLED</span><span class=o>:</span>
</span></span><span class=line><span class=ln>83</span><span class=cl>        <span class=k>return</span> <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>handleResult</span><span class=p>(</span><span class=nx>resolve2</span><span class=p>,</span> <span class=nx>reject2</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>84</span><span class=cl>      <span class=k>case</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>REJECTED</span><span class=o>:</span>
</span></span><span class=line><span class=ln>85</span><span class=cl>        <span class=k>return</span> <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>handleResult</span><span class=p>(</span><span class=nx>resolve2</span><span class=p>,</span> <span class=nx>reject2</span><span class=p>),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>86</span><span class=cl>      <span class=k>case</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=o>:</span>
</span></span><span class=line><span class=ln>87</span><span class=cl>        <span class=c1>// if it&#39;s still pending, push the resolve/reject to callback queue. All the callback functions would be executed once state are changed
</span></span></span><span class=line><span class=ln>88</span><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>self</span><span class=p>.</span><span class=nx>callback</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=ln>89</span><span class=cl>          <span class=nx>resolveFunc</span><span class=o>:</span> <span class=nx>handleResult</span><span class=p>(</span><span class=nx>resolve2</span><span class=p>,</span> <span class=nx>reject2</span><span class=p>),</span>
</span></span><span class=line><span class=ln>90</span><span class=cl>          <span class=nx>rejectFunc</span><span class=o>:</span> <span class=nx>handleResult</span><span class=p>(</span><span class=nx>resolve2</span><span class=p>,</span> <span class=nx>reject2</span><span class=p>),</span>
</span></span><span class=line><span class=ln>91</span><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=ln>92</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>93</span><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=ln>94</span><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Let's simply test it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=kr>const</span> <span class=nx>p1</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>resolve</span><span class=p>(</span><span class=s2>&#34;resolved first one&#34;</span><span class=p>),</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=nx>p1</span><span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;then1: &#34;</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=k>return</span> <span class=nx>res</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;then2: &#34;</span><span class=p>,</span> <span class=nx>res</span><span class=p>),</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=nx>p1</span><span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;another then: &#34;</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=c1>// then1:  resolved first one
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=c1>// another then:  resolved first one
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1>// then2:  resolved first one
</span></span></span></code></pre></div><h2 id=promise-resolution-procedure-23>Promise Resolution Procedure 2.3</h2><p>Here comes the last step, implement the <code>Promise Resolution Procedure</code>. According to the description of requirement:</p><blockquote><p>This treatment of thenables allows promise implementations to interoperate, as long as they expose a Promises/A+-compliant then method. It also allows Promises/A+ implementations to ‚Äúassimilate‚Äù nonconformant implementations with reasonable then methods.</p></blockquote><p>And before we begin to implement, let's think of why we have to have this <code>resolvePromise</code>, since it calls itself inside recursively. Comparing the text explanation, let me present one test case from <a href=https://github.com/promises-aplus/promises-tests/blob/master/lib/tests/2.3.3.js#L332>Promise/A+</a>. The case is generated by two loops, I just pick one here.</p><h3 id=adapter>Adapter</h3><p>In the test case, an adapter is utilized and explained in the Promise/A+ as well, check <a href=https://github.com/promises-aplus/promises-tests#adapters>adapter</a>;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=nb>Promise</span><span class=p>.</span><span class=nx>defer</span> <span class=o>=</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>deferred</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=kd>let</span> <span class=nx>dfd</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=nx>dfd</span><span class=p>.</span><span class=nx>promise</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=nx>dfd</span><span class=p>.</span><span class=nx>resolve</span> <span class=o>=</span> <span class=nx>resolve</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=nx>dfd</span><span class=p>.</span><span class=nx>reject</span> <span class=o>=</span> <span class=nx>reject</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=k>return</span> <span class=nx>dfd</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=nx>adapter</span><span class=p>.</span><span class=nx>resolved</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=kd>var</span> <span class=nx>d</span> <span class=o>=</span> <span class=nx>adapter</span><span class=p>.</span><span class=nx>deferred</span><span class=p>();</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>  <span class=nx>d</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=k>return</span> <span class=nx>d</span><span class=p>.</span><span class=nx>promise</span><span class=p>;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Definitely, we have seen this <code>resolved</code> many times, but what it does exactly? Through its code, we can understand it</p><ol><li>Create a promise with a very simple <code>executor</code> which normally executes the logic of asynchronous codes</li><li>Resolve the promise with the value immediately by updating state and saving the value before we have this <code>resolve</code> method</li><li>Return this created promise</li></ol><p>So for the code <code>resolved(value)</code>, actually it just preserves the value and waiting the <code>resolve</code> method from its <code>then</code>. When its <code>then</code> is called, the value would be passed to <code>resolve</code> method immediately.</p><h3 id=test-case>Test case</h3><p>The test case's description is</p><blockquote><p><code>y</code> is an already-fulfilled promise for a synchronously-fulfilled custom thenable, <code>then</code> calls <code>resolvePromise</code> synchronously</p></blockquote><p>And I can simplify the test code, removing all the wrapped test functions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>result</span> <span class=p>};</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=kd>var</span> <span class=nx>promise</span> <span class=o>=</span> <span class=nx>resolved</span><span class=p>({</span> <span class=nx>dummy</span> <span class=p>}).</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=nx>onBasePromiseFulfilled</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=nx>then</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>resolvePromise</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>      <span class=nx>resolvePromise</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=nx>resolved</span><span class=p>({</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>          <span class=nx>then</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>onFulfilled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>            <span class=nx>onFulfilled</span><span class=p>(</span><span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=nx>promise</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=nx>onPromiseFulfilled</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>  <span class=nx>assert</span><span class=p>.</span><span class=nx>strictEqual</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>result</span><span class=p>);</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>  <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>Yes, HHHHHHHHeadache!!!!</p><p>Definitely there are a lot of promises wrapped like matryoshka doll, and so hard to dig into it. Yes, I know, but we can analysis the codes step by step, at leas we can simply count how many promises are here:</p><ol><li><code>resolved({ dummy })</code> uses <code>resolved</code>. As explained above, it returns a resolved promise and waits for the <code>resolve</code> method from its <code>then</code>. Let's call this promise as <code>promise-TEMP</code>;</li><li><code>promise-TEMP</code> called <code>then</code> which passes the function <code>onBasePromiseFulfilled</code> as <code>resolve</code>. <strong><em>AND</em></strong> it returns our first promise -- <code>promise</code></li><li><code>onBasePromiseFulfilled</code> return a <code>thenable</code> object as value of <code>promise</code>. Let's call it <code>x</code>;</li><li><code>x</code>, which we can simply treat it as a <code>Promise</code> as well -- <code>promise2</code>, has the <code>then</code> function which would call its parameter <code>resolvePromise</code> further. The called value would be the value of <code>promise2</code>. Let's call it <code>y</code>;</li><li>The value passed to <code>resolvePromise</code> is another resolved <code>promise</code> -- <code>promise3</code>, which is fulfilled and has no <code>resolve</code> method. But its value is another thenable object -- or <code>promise4</code>;</li><li>Finally we reach the bottom level, the resolve method <code>onFulfilled</code> of <code>promise4</code>'s <code>then</code> calls the <code>result</code>;</li></ol><p>So let's count how many promises and values we have here (ignore the <code>promise-TEMP</code>):</p><ol><li><code>promise</code> -- the only one having name in our test codes<ol><li>its value <code>x</code> -> <code>promise2</code></li></ol></li><li><code>promise2</code> -- first thenable object<ol><li>its value <code>y</code> -> <code>promise3</code></li></ol></li><li><code>promise3</code> -- a resolved <code>promise</code><ol><li>its value -> <code>promise4</code></li></ol></li><li><code>promise4</code> -- second thenable object<ol><li>its value -> <code>result</code>, an object</li></ol></li></ol><p>So we can see the value of <code>promise</code> is a promise -- <code>promise2</code> which wraps another two promises -- <code>promise3</code> and <code>promise4</code>. And the <code>assert</code> sits inside of the resolve <code>onPromiseFulfilled</code> method of the first <code>promise</code>, it would expect the value returned by <code>onPromiseFulfilled</code> to be the same with <code>result</code>, which is the value of <code>promise4</code>.</p><p>We can conclude some points here:</p><ol><li>The thenable object can be treated as a promise, which means they can be handled as the same codes. (<em>This is not a principle, we can discuss this in another blog</em>)</li><li>If the value of a promise is a thenable object, the promise's resolve/reject methods would be passed to the value until the final value is not a promise and handled by the original resolve/reject methods.</li></ol><h3 id=implementation>Implementation</h3><p>OK, it's enough to learn from the test case, even though it's what I learned after I passed all the test cases. Let's go back to the requirements and implement it.</p><p>Since thenable object can be treated as promise, we would ignore the requirement of <code>2.3.2</code>:</p><blockquote><p>2.3.2 If x is a promise, adopt its state [3.4]:<br>¬†¬†¬† 2.3.2.1 If x is pending, promise must remain pending until x is fulfilled or rejected.<br>¬†¬†¬†2.3.2.2 If/when x is fulfilled, fulfill promise with the same value.<br>¬†¬†¬†2.3.2.3 If/when x is rejected, reject promise with the same reason.</p></blockquote><p>This point can be merged with <code>2.3.3</code>. Others would not be hard, just follow the steps:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nx>resolvePromise</span><span class=p>(</span><span class=nx>promise</span><span class=p>,</span> <span class=nx>x</span><span class=p>,</span> <span class=nx>resolve2</span><span class=p>,</span> <span class=nx>reject2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>promise</span> <span class=o>==</span> <span class=nx>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=k>return</span> <span class=nx>reject2</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>      <span class=k>new</span> <span class=nx>TypeError</span><span class=p>(</span><span class=s2>&#34;Resolved result should not be the same promise!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>x</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span> <span class=o>||</span> <span class=nx>isObject</span><span class=p>(</span><span class=nx>x</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=kd>let</span> <span class=nx>called</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=c1>// 2.3.3.3.3
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>      <span class=kd>let</span> <span class=nx>then</span> <span class=o>=</span> <span class=nx>x</span><span class=p>.</span><span class=nx>then</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isFunction</span><span class=p>(</span><span class=nx>then</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>        <span class=nx>then</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>          <span class=c1>// 2.3.3.3
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=c1></span>          <span class=nx>x</span><span class=p>,</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>          <span class=kd>function</span> <span class=p>(</span><span class=nx>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>called</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span> <span class=c1>// 2.3.3.3.3
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1></span>            <span class=nx>called</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>            <span class=k>return</span> <span class=nx>resolvePromise</span><span class=p>(</span><span class=nx>promise</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>resolve2</span><span class=p>,</span> <span class=nx>reject2</span><span class=p>);</span> <span class=c1>// 2.3.3.3.1
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=c1></span>          <span class=p>},</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>          <span class=kd>function</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>called</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>            <span class=nx>called</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>            <span class=k>return</span> <span class=nx>reject2</span><span class=p>(</span><span class=nx>r</span><span class=p>);</span> <span class=c1>// 2.3.3.3.2
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>        <span class=nx>resolve2</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 2.3.3.4
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>called</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span> <span class=c1>// 2.3.3.3.4.1
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=c1></span>      <span class=nx>called</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>      <span class=nx>reject2</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span> <span class=c1>// 2.3.3.3.4.2
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>    <span class=nx>resolve2</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span> <span class=c1>// 2.3.4
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=ln>38</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=test>Test</h2><p>Now we have implemented all the mandatory codes, we can run the test the codes with npm lib <a href=https://www.npmjs.com/package/promises-aplus-tests>promises-aplus-tests</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>npm i -g promises-aplus-tests
</span></span><span class=line><span class=ln>2</span><span class=cl>promises-aplus-tests promise1.js // promise1.js is the file name
</span></span></code></pre></div><p>The full code can be checked <a href=https://github.com/xfsnowind/promise-implementation>here</a>. There are different versions with different techniques, you can choose anyone.</p><h2 id=summary>Summary</h2><p>This solution is not perfect and it just simply follows the rules of Promise/A+ without any better architecture and design. There are a lot of good solutions which restructures the codes with their own idea and logic. I would rewrite the promise with other techniques later.</p><p>Besides, this version just completes the basic part. Promise also has <code>resolve</code>, <code>catch</code>, <code>finally</code>, etc. I will implement them as well and write another article about them.</p><p>Thanks to <a href=https://developpaper.com/source-code-implementation-of-promise-perfect-in-accordance-with-promise-a-specification/>this article</a>, which inspires me to make decision to implement the Promise and <a href=https://medium.com/swlh/implement-a-simple-promise-in-javascript-20c9705f197a>Zhi Sun's article</a>, which reminders me of taking steps to implement the hard part.</p><p>---------------------- UPDATE ----------------------</p><p>Instead prototype, I have implemented the Promise with javascript class, which is not the feature of ES5, therefore, we need to compile it with babel and test with nodejs. And the code logic is almost the same with the version 1. Here is the <a href=https://github.com/xfsnowind/promise-implementation/tree/main/classVersion>code</a>.</p><p>There are two things we need to take care when using class:</p><ol><li>When we pass the <code>#internalResolve/#internalReject</code> functions which are defined as class private methods, to <code>executor</code>, we need to use <code>bind</code> to bind the function with class's instance or <code>this</code>, since we use <code>this</code> inside of <code>#internalResolve/#internalReject</code>. Codes are:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=nx>constructor</span><span class=p>(</span><span class=nx>executor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=nx>executor</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=err>#</span><span class=nx>internalResolve</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=k>this</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=err>#</span><span class=nx>internalReject</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=err>#</span><span class=nx>internalReject</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=err>#</span><span class=nx>internalResolve</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=err>#</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=err>#</span><span class=nx>internalReject</span><span class=p>(</span><span class=nx>reason</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=err>#</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>STATE</span><span class=p>.</span><span class=nx>PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=c1>//...
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ol start=2><li>Be careful for <code>this</code> especially when we create functions inside of class methods. It's best to define a variable and assign <code>this</code> to it, like <code>self</code>.</li></ol></div><div class=post_comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//xfsnowind.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article><aside class=sidebar><section class=sidebar_inner><br><div class=search><input type=search class="search_field form_field" placeholder=Search... id=find autocomplete=off data-scope=blogs>
<label for=find class=search_label><svg class="icon"><title>search</title><use xlink:href="#search"/></svg></label><div class="search_results results"></div></div><div class=post_toc><h2>Overview</h2><nav id=TableOfContents><ul><li><a href=#steps>Steps</a></li><li><a href=#basic-thenable>Basic <code>thenable</code></a></li><li><a href=#fulfill-promise-and-then-parameters>Fulfill <code>Promise</code> and <code>then</code> parameters</a><ul><li><a href=#validate-then-parameters>Validate <code>then</code> parameters</a></li><li><a href=#update-state>Update state</a></li><li><a href=#asynchronized-execution>Asynchronized execution</a></li></ul></li><li><a href=#return-promise-in-then>Return <code>Promise</code> in <code>then</code></a><ul><li><a href=#call-then-mutiple-times-226>Call <code>then</code> mutiple times 2.2.6</a></li><li><a href=#return-promise-227>Return <code>Promise</code> 2.2.7</a></li></ul></li><li><a href=#promise-resolution-procedure-23>Promise Resolution Procedure 2.3</a><ul><li><a href=#adapter>Adapter</a></li><li><a href=#test-case>Test case</a></li><li><a href=#implementation>Implementation</a></li></ul></li><li><a href=#test>Test</a></li><li><a href=#summary>Summary</a></li></ul></nav></div><h2 class=mt-4>Recent Posts</h2><ul class=flex-column><li><a href=https://xfsnowind.github.io/blogs/azure-challenge/ class=nav-link title="Learning Notes - Azure Challenge">Learning Notes - Azure Challenge</a></li><li><a href=https://xfsnowind.github.io/blogs/geektime/react-hooks/ class=nav-link title="Learning Notes - React Hooks">Learning Notes - React Hooks</a></li><li><a href=https://xfsnowind.github.io/blogs/promise/ class=nav-link title="Promise implementation">Promise implementation</a></li><li><a href=https://xfsnowind.github.io/blogs/learning-plan/ class=nav-link title="Learning Plan">Learning Plan</a></li></ul><div><h2 class="mt-4 taxonomy" id=tags-section>Tags</h2><nav class=tags_nav><a href=https://xfsnowind.github.io/tags/javascript/ class="post_tag button button_translucent" title=javascript>JAVASCRIPT
<span class=button_tally>2</span></a>
<a href=https://xfsnowind.github.io/tags/learning-notes/ class="post_tag button button_translucent" title=learning-notes>LEARNING-NOTES
<span class=button_tally>2</span></a>
<a href=https://xfsnowind.github.io/tags/azure/ class="post_tag button button_translucent" title=azure>AZURE
<span class=button_tally>1</span></a>
<a href=https://xfsnowind.github.io/tags/promise/ class="post_tag button button_translucent" title=promise>PROMISE
<span class=button_tally>1</span></a>
<a href=https://xfsnowind.github.io/tags/react-hooks/ class="post_tag button button_translucent" title=react-hooks>REACT-HOOKS
<span class=button_tally>1</span></a></nav></div></section></aside></div></main><svg width="0" height="0" class="hidden"><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter"><path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68.0 01-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043.0-1.924.366-2.643 1.078A3.56 3.56.0 008.766 5.383c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846.0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47.0.929.273 1.705.82 2.388a3.623 3.623.0 002.115 1.291c-.312.08-.641.118-.979.118-.312.0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652.0 002.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422.0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139.0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77.0 001.172-4.892v-.468a7.788 7.788.0 001.84-1.921 8.142 8.142.0 01-2.11.593z"/></symbol><symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar"><path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916.0 1e2v352c0 33.084 26.916 60 60 60h392c33.084.0 60-26.916 60-60V1e2c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028.0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028.0 20 8.972 20 20v48z"/><path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github"><path d="M255.968 5.329C114.624 5.329.0 120.401.0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384.0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008.0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992.0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584.0 34.368-.32 62.08-.32 70.496.0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab"><path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6.0L12.3 74.8z"/><path d="M12.3 74.7.5 111c-1 3.2.0 6.8 3 8.8l101.6 74-92.5-119z"/><path d="M105 193.7l-38.6-119h-54l92.7 119z"/><path d="M105 193.7l38.7-119H66.4l38.7 119z"/><path d="M105 193.7l38.7-119H198l-93 119z"/><path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/><path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6.0L198 74.8z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss"><circle cx="3.429" cy="20.571" r="3.429"/><path d="M11.429 24h4.57C15.999 15.179 8.821 8.001.0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"/><path d="M24 24C24 10.766 13.234.0.0.0v4.571c10.714.0 19.43 8.714 19.43 19.429z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h362c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top"><path d="M604.501 440.509 325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298.0 36.323s26.223 10.024 36.222.0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221.0 9.999-10.023 9.999-26.298.0-36.323z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly"><path d="M504.971 239.029 448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c19.851.0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002.0 004e2 320v108c0 19.851-16.149 36-36 36h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c46.318.0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568.0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255.0 24-10.745 24-24S205.255.0 192 0h-44c-46.318.0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568.0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255.0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851.0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002.0 00112 192z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy"><path d="M23 2.75A2.75 2.75.0 0020.25.0H8.75A2.75 2.75.0 006 2.75v13.5A2.75 2.75.0 008.75 19h11.5A2.75 2.75.0 0023 16.25zM18.25 14.5h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5z"/><path d="M8.75 20.5A4.255 4.255.0 014.5 16.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752.0 001 5.25v16A2.752 2.752.0 003.75 24h12a2.752 2.752.0 002.75-2.75v-.75z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme"><path d="M284.286 256.002 506.143 34.144c7.811-7.811 7.811-20.475.0-28.285-7.811-7.81-20.475-7.811-28.285.0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285.0-7.81 7.811-7.811 20.475.0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475.0 28.285a19.938 19.938.0 0014.143 5.857 19.94 19.94.0 0014.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475.0-28.285L284.286 256.002z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu"><path d="M492 236H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954.0 96s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram"><path d="M12 2.163c3.204.0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849.0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204.0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849.0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741.0 8.333.014 7.053.072c-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.668.072 4.948c.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24s3.668-.014 4.948-.072c4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403.0-6.162 2.759-6.162 6.162S8.597 18.163 12 18.163s6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zM12 16c-2.209.0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796.0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795.0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="youtube"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23.0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23.0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.549-4.385-8.816zM9 16V8l8 3.993L9 16z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow"><path d="M21 27v-8h3v11H0V19h3v8h18z"/><path d="M17.1.2 15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8 13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord"><path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527.41542 45.5603.39851 45.468.440769 45.4204.525289 44.7963 1.6353 44.105 3.0834 43.6209 4.2216c-5.4572-.817-10.8864-.817-16.2317.0C26.905 3.0581 26.1886 1.6353 25.5617.525289 25.5141.443589 25.4218.40133 25.3294.41542c-5.071.87338-9.9237 2.40318-14.4518 4.48238C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795 1.57795 18.7309-.943561 32.1443.293408 45.3914.299005 45.4562.335386 45.5182.385761 45.5576 6.45866 50.0174 12.3413 52.7249 18.1147 54.5195 18.2071 54.5477 18.305 54.5139 18.3638 54.4378 19.7295 52.5728 20.9469 50.6063 21.9907 48.5383 22.0523 48.4172 21.9935 48.2735 21.8676 48.2256 19.9366 47.4931 18.0979 46.6 16.3292 45.5858 16.1893 45.5041 16.1781 45.304 16.3068 45.2082 16.679 44.9293 17.0513 44.6391 17.4067 44.3461 17.471 44.2926 17.5606 44.2813 17.6362 44.3151c11.6196 5.3051 24.1992 5.3051 35.6817.0C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433 53.9057 44.6363 54.2779 44.9293 54.6529 45.2082 54.7816 45.304 54.7732 45.5041 54.6333 45.5858c-1.7687 1.0339-3.6074 1.9073-5.5412 2.637C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383c1.0662 2.0651 2.2836 4.0316 3.6241 5.8967C52.6519 54.5139 52.7526 54.5477 52.845 54.5195c5.8014-1.7946 11.684-4.5021 17.7569-8.9619C70.6551 45.5182 70.6887 45.459 70.6943 45.3942 72.1747 30.0791 68.2147 16.7757 60.1968 4.9823 60.1772 4.9429 60.1437 4.9147 60.1045 4.8978zM23.7259 37.3253c-3.4983.0-6.3808-3.2117-6.3808-7.156s2.8266-7.156 6.3808-7.156c3.5821.0 6.4367 3.2399 6.3807 7.156.0 3.9443-2.8266 7.156-6.3807 7.156zm23.5919.0c-3.4982.0-6.3807-3.2117-6.3807-7.156s2.8265-7.156 6.3807-7.156c3.5822.0 6.4367 3.2399 6.3808 7.156.0 3.9443-2.7986 7.156-6.3808 7.156z"/></symbol></svg><footer class=footer><div class="footer_inner wrap pale"><img src=https://xfsnowind.github.io/icons/apple-touch-icon.png class="icon icon_2 transparent" alt=xfsnowind><p>Copyright&nbsp;<span class=year></span>&nbsp;XFSNOWIND. All Rights Reserved</p><a class=to_top href=#documentTop><svg class="icon"><title>to-top</title><use xlink:href="#to-top"/></svg></a></div></footer><script type=text/javascript src=https://xfsnowind.github.io/en/js/bundle.abda53b0d8eb8de877a2fbec2599375291f77ae51211052d48f67bac51bab59515a0317b52db7e934e984e7f67086227055e81e818724a66f0ef38d841085056.js integrity="sha512-q9pTsNjrjeh3ovvsJZk3UpH3euUSEQUtSPZ7rFG6tZUVoDF7Utt+k06YTn9nCGInBV6B6BhySmbw7zjYQQhQVg==" crossorigin=anonymous></script>
<script src=https://xfsnowind.github.io/js/search.min.9641a8a49c5a7dbd99f372bf456fc577a23b235fd157ee614ce2dab96b2e0f3687d5cc408d875f32e94405a2ccbca5c8bc43491cfce32471b72aa63e5315018d.js></script></body></html>